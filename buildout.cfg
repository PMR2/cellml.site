[buildout]
newest = false
prefer-final = true
#
# The high experimental recipe to run Plone 3.2 on Repoze
#
# Based on discussiong on #repoze@freenode
#
# For repoze debug use only! 
#
# 1. Run this buildout
#
# 2. Copy debug.ini to parts/instance/var/etc
#
# 3. Start instance::
# 
#        bin/paster server parts/instance/etc/debug.ini 
#
#
# TODO: Zope 2 gets pulled in twice - See [zope2] and [zope2dummy]
#

extends = 
    http://dist.plone.org/release/3.2.3/versions.cfg

find-links =
    http://dist.repoze.org/zope2/2.10/
    http://dist.plone.org/release/3.2.3/
    http://dist.plone.org
    http://download.zope.org/ppix/
    http://download.zope.org/distribution/
    http://effbot.org/downloads
    https://svn.physiomeproject.org/svn/physiome/snapshots/python-dist/

parts = ${testing:parts}
develop = ${testing:develop}

eggs =
    Plone
    elementtree
    repoze.debug

versions = versions

[versions]
zope.testing = 3.6.0
elementtree = 1.2.6-20050316
zope.component = 3.5.1
zope.i18n = 3.5.0
zopelib = 2.10.7.0
Products.ResourceRegistries = 1.5.0
z3c.form = 1.9.0
cellml.theme = 0.8

[base]
parts =
    zope2
    zope2dummy
    productdistros
    zopepy

[testing]
parts =
    ${base:parts}
    paster-testing
    instance-testing
    zeoserver-testing

develop =
    src/cellml.theme

# Staging instance: parts for staging server

[staging]
parts =
    ${base:parts}
    paster-staging
    instance-staging
    zeoserver-staging

# split up builds
[staging-instance]
parts =
    ${base:parts}
    paster-staging
    instance-staging

[staging-zeoserver]
parts =
    zeoserver-staging

# Deployment instance: parts for production server
[deploy]
parts =
    ${base:parts}
    paster-deploy
    instance-deploy
    zeoserver-deploy

# split up builds
[deploy-instance]
parts =
    ${base:parts}
    paster-deploy
    instance-deploy

[deploy-zeoserver]
parts =
    zeoserver-deploy

# Addresses

[host]
name = www.cellml.org

instance-testing = 127.0.0.1
instance-staging = 127.0.0.1
instance-deploy = 127.0.0.1

zeoserver-testing = 127.0.0.1
zeoserver-staging = 127.0.0.1
zeoserver-deploy = 127.0.0.1

[port]
instance-testing = 13080
instance-staging = 13080
instance-deploy = 13080

zeoserver-testing = 13001
zeoserver-staging = 13001
zeoserver-deploy = 13001

### Definitions for the software parts.
# Zeo server

[zeoserver-testing]
recipe = plone.recipe.zope2zeoserver
zope2-location = ${instance-settings:zope2-location}
zeo-address = ${port:zeoserver-testing}

[zeoserver-staging]
recipe = plone.recipe.zope2zeoserver
zope2-location = ${instance-settings:zope2-location}
zeo-address = ${port:zeoserver-staging}
# TODO define location of socket, data.fs, etc.
#file-storage = var/filestorage/Data.fs
#socket-name = var/zeo.zdsock

[zeoserver-deploy]
recipe = plone.recipe.zope2zeoserver
zope2-location = ${instance-settings:zope2-location}
zeo-address = ${port:zeoserver-deploy}
effective-user = zope
# TODO define location of socket, data.fs, etc.
#file-storage = var/filestorage/Data.fs
#socket-name = var/zeo.zdsock

# Zope

[zope2]
recipe = repoze.recipe.egg
eggs =
   ${buildout:eggs}
   repoze.zope2
#
# Pull in zope utilities to create instance - mkzopeinstance.py (repoze.zope2 seem to lack it)
# Needed for [instance]
# 
# Zope 2 Python files get stored in parts/zope2dummy/lib/python and eggs/zopelib as well
# 
# 
[zope2dummy]
# For more information on this step and configuration options see:
# http://pypi.python.org/pypi/plone.recipe.zope2install
recipe = plone.recipe.zope2install
fake-zope-eggs = true
additional-fake-eggs = 
    ZConfig
    pytz
    zope.i18n = 3.5.0
skip-fake-eggs =
    zope.testing
# from Plone3.2 versions.cfg extension
    ZODB3
url = ${versions:zope2-url}

[productdistros]
recipe = plone.recipe.distros
urls =
nested-packages =
version-suffix-packages =

### Servers

# Paster

[paster-testing]
recipe = repoze.recipe.egg:scripts
eggs = 
    ${zope2:eggs}
    ${instance-settings:eggs}
    ${instance-testing:eggs}
scripts = paster=paster-testing

[paster-staging]
recipe = repoze.recipe.egg:scripts
eggs = 
    ${zope2:eggs}
    ${instance-settings:eggs}
    ${instance-staging:eggs}
scripts = paster=paster-migrated

[paster-deploy]
recipe = repoze.recipe.egg:scripts
eggs = 
    ${zope2:eggs}
    ${instance-settings:eggs}
    ${instance-deploy:eggs}
scripts = paster=paster-staging

# Instances

[instance-settings]
# For more information on this step and configuration options see:
# http://pypi.python.org/pypi/plone.recipe.zope2instance
zope2-location = ${zope2dummy:location}
zeo-client = true
zodb-cache-size = 5000
zeo-client-cache-size = 300MB
user = admin:admin
debug-mode = on
verbose-security = on

# If you want Zope to know about any additional eggs, list them here.
# This should include any development eggs you listed in develop-eggs above,
# e.g. eggs = Plone my.package
eggs =
    Plone
    PILwoTK
    Products.PloneSoftwareCenter
    Products.ArchAddOn
    Products.AddRemoveWidget
    Products.DocFinderTab
    Products.ExternalStorage
    cellml.theme
    Products.TinyMCE
    ${buildout:eggs}
    
# If you want to register ZCML slugs for any packages, list them here.
# e.g. zcml = my.package my.other.package
zcml =
    cellml.theme

products =
    ${buildout:directory}/products
    ${productdistros:location}

# TODO split out the external storage path per instance

environment-vars =
    PYTHON_EGG_CACHE ${buildout:directory}/var/.python-eggs
    EXTERNAL_STORAGE_BASE_PATH ${buildout:directory}/var

### Instances

[instance-testing]
recipe = collective.recipe.zope2cluster
instance-clone = instance-settings
http-address = ${port:instance-testing}
zeo-address = ${host:zeoserver-testing}:${port:zeoserver-testing}
zeo-var = ${buildout:directory}/var

[instance-staging]
recipe = collective.recipe.zope2cluster
instance-clone = instance-settings
http-address = ${port:instance-staging}
zeo-address = ${host:zeoserver-staging}:${port:zeoserver-staging}
zeo-var = ${buildout:directory}/var
debug-mode = off
verbose-security = off
effective-user = zope
eggs +=
    ${python-ldap:egg}
    simplon.plone.ldap

[instance-deploy]
recipe = collective.recipe.zope2cluster
instance-clone = instance-settings
http-address = ${port:instance-deploy}
zeo-address = ${host:zeoserver-deploy}:${port:zeoserver-deploy}
zeo-var = ${buildout:directory}/var
debug-mode = off
verbose-security = off
effective-user = zope
eggs +=
    ${python-ldap:egg}
    simplon.plone.ldap
    collective.recaptcha

[zopepy]
recipe = zc.recipe.egg
eggs = ${instance-settings:eggs}
interpreter = zopepy
extra-paths = ${zope2dummy:location}/lib/python
scripts = zopepy

# LDAP.

[openldap]
recipe = zc.recipe.cmmi
url = http://gd4.tuwien.ac.at/infosys/network/OpenLDAP/openldap-stable/openldap-stable-20071118.tgz
md5sum = e3fec2953c948f6990ccdc3af7bf7f18
extra_options = --with-sasl --with-tls --enable-slapd=no

[python-ldap]
recipe = zc.recipe.egg:custom
egg = python-ldap
include-dirs  =
       ${openldap:location}/include
library-dirs  =
       ${openldap:location}/lib
rpath =
       ${openldap:location}/lib

